<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Money HUD FULL PERSISTENT</title>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:sans-serif;background:#0f172a;color:#fff}
header{padding:12px;background:#111827}
.card{background:#1e293b;margin:10px;padding:15px;border-radius:12px}
.online{color:#22c55e}
.offline{color:#ef4444}
input{padding:5px;border-radius:6px;border:none;width:120px}
canvas{background:#0b1220;border-radius:10px;margin-top:10px}
</style>
</head>
<body>

<header>ðŸš€ Money HUD â€“ FULL PERSISTENT</header>
<div id="container"></div>

<script>
// ===== FIREBASE =====
firebase.initializeApp({
 apiKey:"demo",
 authDomain:"roblox-money-tracker.firebaseapp.com",
 databaseURL:"https://roblox-money-tracker-default-rtdb.firebaseio.com",
 projectId:"roblox-money-tracker"
});
const db=firebase.database();

// ===== CONFIG =====
const MAX_EVENTS=60;
const MAX_CHART_POINTS=120;
const MIN_GAP=0.3;
const MAX_GAP=300;
const EMA_ALPHA=0.25;

let players={};

// ===== STORAGE =====
function savePlayer(id){
 const clone={...players[id]};
 delete clone.chart;
 localStorage.setItem("player_"+id,JSON.stringify(clone));
}
function loadPlayer(id){
 const data=localStorage.getItem("player_"+id);
 if(data) return JSON.parse(data);
 return null;
}

// ===== INIT =====
function ensurePlayer(id){
 if(!players[id]){
   let saved=loadPlayer(id);
   players[id]= saved || {
     money:0,
     lastMoney:null,
     lastMoveTime:null,
     events:[],
     emaRate:0,
     goal:0,
     chartData:[],
     lastUpdate:Date.now(),
     chart:null
   };
   createCard(id);
 }
}

function createCard(id){
 const div=document.createElement("div");
 div.className="card";
 div.id="card-"+id;
 div.innerHTML=`
 <h3>${id} <span id="state-${id}" class="online">Online</span></h3>
 <div id="money-${id}">à¸¿ 0</div>
 <div id="hour-${id}"></div>
 <div id="day-${id}"></div>
 <div>
   ðŸŽ¯ à¹€à¸›à¹‰à¸²:
   <input type="number" id="goal-${id}">
   <button onclick="setGoal('${id}')">à¸•à¸±à¹‰à¸‡</button>
 </div>
 <div id="eta-${id}"></div>
 <canvas id="chart-${id}" height="100"></canvas>
 `;
 document.getElementById("container").appendChild(div);

 const ctx=document.getElementById("chart-"+id).getContext("2d");

 players[id].chart=new Chart(ctx,{
   type:'line',
   data:{
     labels:new Array(players[id].chartData.length).fill(""),
     datasets:[{
       data:players[id].chartData,
       borderColor:'#22c55e',
       tension:0.3
     }]
   },
   options:{
     responsive:true,
     plugins:{legend:{display:false}},
     scales:{x:{display:false}}
   }
 });

 if(players[id].goal){
   document.getElementById("goal-"+id).value=players[id].goal;
 }

 render(id);
}

function setGoal(id){
 players[id].goal=parseFloat(
  document.getElementById("goal-"+id).value
 )||0;
 savePlayer(id);
}

// ===== UPDATE =====
function updatePlayer(id,data){
 ensurePlayer(id);
 const p=players[id];
 const now=Date.now();

 const money=data.Money||0;
 const diff=data.LastDiff||0;

 p.lastUpdate=now;

 if(p.lastMoney!==null && money!==p.lastMoney){
   let gap=(now-(p.lastMoveTime||now))/1000;

   if(diff>0 && gap>=MIN_GAP && gap<=MAX_GAP){
     p.events.push({amount:diff,gap:gap});
     if(p.events.length>MAX_EVENTS) p.events.shift();
   }

   p.lastMoveTime=now;
 }

 p.lastMoney=money;
 p.money=money;

 calculate(id);
 updateChart(id,money);

 savePlayer(id);
}

function calculate(id){
 const p=players[id];
 let totalAmount=0,totalTime=0;

 p.events.forEach(e=>{
   totalAmount+=e.amount;
   totalTime+=e.gap;
 });

 let rate=0;
 if(totalTime>0) rate=totalAmount/totalTime;

 p.emaRate = p.emaRate===0 ? rate :
   (EMA_ALPHA*rate + (1-EMA_ALPHA)*p.emaRate);

 let hour=p.emaRate*3600;
 let day=hour*24;

 document.getElementById("money-"+id).textContent=
  "à¸¿ "+p.money.toLocaleString();

 document.getElementById("hour-"+id).textContent=
  "ðŸ’° à¸•à¹ˆà¸­à¸Šà¸±à¹ˆà¸§à¹‚à¸¡à¸‡: "+Math.floor(hour).toLocaleString();

 document.getElementById("day-"+id).textContent=
  "ðŸ“… à¸•à¹ˆà¸­à¸§à¸±à¸™: "+Math.floor(day).toLocaleString();

 let eta="-";
 if(p.goal>0 && p.emaRate>0){
   if(p.money>=p.goal){
     eta="à¸–à¸¶à¸‡à¹€à¸›à¹‰à¸²à¹à¸¥à¹‰à¸§ âœ…";
   }else{
     let sec=(p.goal-p.money)/p.emaRate;
     let h=Math.floor(sec/3600);
     let m=Math.floor((sec%3600)/60);
     eta=`à¸­à¸µà¸ ${h} à¸Šà¸¡. ${m} à¸™à¸²à¸—à¸µ`;
   }
 }
 document.getElementById("eta-"+id).textContent="â³ "+eta;
}

function updateChart(id,money){
 const p=players[id];
 p.chartData.push(money);
 if(p.chartData.length>MAX_CHART_POINTS)
   p.chartData.shift();

 const chart=p.chart;
 chart.data.labels=new Array(p.chartData.length).fill("");
 chart.data.datasets[0].data=p.chartData;
 chart.update();
}

// ===== ONLINE =====
setInterval(()=>{
 const now=Date.now();
 Object.keys(players).forEach(id=>{
   const p=players[id];
   if(now-p.lastUpdate>300000){
     document.getElementById("state-"+id).textContent="Offline";
     document.getElementById("state-"+id).className="offline";
   }else{
     document.getElementById("state-"+id).textContent="Online";
     document.getElementById("state-"+id).className="online";
   }
 });
},5000);

// ===== LISTEN DB =====
db.ref("Stats").on("value",snap=>{
 const data=snap.val();
 if(!data) return;
 Object.keys(data).forEach(id=>{
   updatePlayer(id,data[id]);
 });
});
</script>

</body>
</html>
